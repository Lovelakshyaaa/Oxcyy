name: Build APK
on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
          cache: 'gradle'

      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      # ---------------------------------------------------
      # STEP: SAFE GENERATION (The "Absolute Control" Version)
      # ---------------------------------------------------
      - name: üõ°Ô∏è FINAL FIXED BUILD GENERATION
        run: |
          flutter config --no-analytics
          flutter create --platforms=android .
          
          # 1. SETTINGS.GRADLE
          echo 'pluginManagement {
              def flutterSdkPath = {
                  def properties = new Properties()
                  file("local.properties").withInputStream { properties.load(it) }
                  return properties.getProperty("flutter.sdk")
              }()
              includeBuild("$flutterSdkPath/packages/flutter_tools/gradle")
              repositories { google(); mavenCentral(); gradlePluginPortal() }
          }
          plugins {
              id "dev.flutter.flutter-plugin-loader" version "1.0.0"
              id "com.android.application" version "8.3.2" apply false
              id "org.jetbrains.kotlin.android" version "1.9.23" apply false
          }
          include ":app"' > android/settings.gradle

          # 2. GRADLE.PROPERTIES (The "Safety Valve" üõ°Ô∏è)
          # This tells Gradle: "Don't stop the build if JVM versions are slightly off"
          echo 'org.gradle.jvmargs=-Xmx4G
          android.useAndroidX=true
          android.enableJetifier=true
          kotlin.code.style=official
          kotlin.jvm.target.validation.mode=ignore' > android/gradle.properties

          # 3. ROOT BUILD.GRADLE (The JVM Dictator üëÆ)
          echo 'allprojects {
              repositories { google(); mavenCentral() }
          }
          rootProject.buildDir = "../build"
          subprojects {
              project.buildDir = "${rootProject.buildDir}/${project.name}"
              project.evaluationDependsOn(":app")

              // FORCE EVERY SUB-LIBRARY (like audio_session) TO JAVA 17
              afterEvaluate { project ->
                  if (project.hasProperty("android")) {
                      project.android {
                          compileOptions {
                              sourceCompatibility = JavaVersion.VERSION_17
                              targetCompatibility = JavaVersion.VERSION_17
                          }
                          // Force Kotlin to 17 too
                          if (project.tasks.findByName("compileDebugKotlin")) {
                              tasks.withType(org.jetbrains.kotlin.gradle.tasks.KotlinCompile).configureEach {
                                  kotlinOptions { jvmTarget = "17" }
                              }
                          }
                      }
                  }
              }
          }
          tasks.register("clean", Delete) { delete rootProject.buildDir }' > android/build.gradle

          # 4. APP/BUILD.GRADLE
          echo 'plugins {
              id "com.android.application"
              id "org.jetbrains.kotlin.android"
              id "dev.flutter.flutter-gradle-plugin"
          }
          android {
              namespace "com.example.oxcy"
              compileSdkVersion 35
              defaultConfig {
                  applicationId "com.example.oxcy"
                  minSdkVersion 24
                  targetSdkVersion 35
              }
              compileOptions {
                  sourceCompatibility JavaVersion.VERSION_17
                  targetCompatibility JavaVersion.VERSION_17
              }
              kotlinOptions { jvmTarget = "17" }
              buildTypes {
                  release {
                      signingConfig signingConfigs.debug
                      minifyEnabled true
                      proguardFiles(getDefaultProguardFile("proguard-android.txt"), "proguard-rules.pro")
                  }
              }
          }
          dependencies {
              implementation "org.jetbrains.kotlin:kotlin-stdlib-jdk7:1.9.23"
          }' > android/app/build.gradle

      # ---------------------------------------------------
      # üßπ NUCLEAR CLEAN & BUILD
      # ---------------------------------------------------
      - name: ‚ò¢Ô∏è FLUSHING CACHES & BUILDING
        run: |
          flutter clean
          flutter pub get
          flutter build apk --release --no-tree-shake-icons

      - uses: actions/upload-artifact@v4
        with:
          name: oxcy-release-apk
          path: build/app/outputs/flutter-apk/app-release.apk
