name: Build APK
on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
          cache: 'gradle'

      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      # ---------------------------------------------------
      # üõ°Ô∏è THE BULLETPROOF GENERATION
      # ---------------------------------------------------
      - name: üèóÔ∏è Reconstructing Android Project
        run: |
          flutter config --no-analytics
          flutter create --platforms=android .
          
          # 1. Clean old files
          rm -f android/settings.gradle android/build.gradle android/app/build.gradle
          rm -f android/gradle/wrapper/gradle-wrapper.properties

          # 2. SETTINGS.GRADLE (The Root Map)
          echo 'pluginManagement {
              def flutterSdkPath = {
                  def properties = new Properties()
                  file("local.properties").withInputStream { properties.load(it) }
                  return properties.getProperty("flutter.sdk")
              }()
              includeBuild("$flutterSdkPath/packages/flutter_tools/gradle")
              repositories { google(); mavenCentral(); gradlePluginPortal() }
          }
          plugins {
              id "dev.flutter.flutter-plugin-loader" version "1.0.0"
              id "com.android.application" version "8.3.2" apply false
              id "org.jetbrains.kotlin.android" version "1.9.23" apply false
          }
          include ":app"' > android/settings.gradle

          # 3. ROOT BUILD.GRADLE (The Global Repo Fix)
          echo 'allprojects {
              repositories { google(); mavenCentral() }
          }
          rootProject.buildDir = "../build"
          subprojects {
              project.buildDir = "${rootProject.buildDir}/${project.name}"
          }
          subprojects {
              project.evaluationDependsOn(":app")
          }
          tasks.register("clean", Delete) { delete rootProject.buildDir }' > android/build.gradle

          # 4. APP/BUILD.GRADLE (The Android 15 Core)
          echo 'plugins {
              id "com.android.application"
              id "org.jetbrains.kotlin.android"
              id "dev.flutter.flutter-gradle-plugin"
          }
          android {
              namespace "com.example.oxcy"
              compileSdkVersion 35
              ndkVersion flutter.ndkVersion
              compileOptions {
                  sourceCompatibility JavaVersion.VERSION_17
                  targetCompatibility JavaVersion.VERSION_17
              }
              kotlinOptions { jvmTarget = "17" }
              defaultConfig {
                  applicationId "com.example.oxcy"
                  minSdkVersion 24
                  targetSdkVersion 35
                  versionCode 1
                  versionName "1.0"
              }
              buildTypes {
                  release {
                      signingConfig signingConfigs.debug
                      minifyEnabled true
                      proguardFiles(getDefaultProguardFile("proguard-android.txt"), "proguard-rules.pro")
                  }
              }
          }
          dependencies {
              implementation "org.jetbrains.kotlin:kotlin-stdlib:1.9.23"
          }' > android/app/build.gradle

          # 5. GRADLE WRAPPER (Fixes :gradle:compileKotlin)
          mkdir -p android/gradle/wrapper
          echo 'distributionBase=GRADLE_USER_HOME
          distributionPath=wrapper/dists
          zipStoreBase=GRADLE_USER_HOME
          zipStorePath=wrapper/dists
          distributionUrl=https\://services.gradle.org/distributions/gradle-8.7-all.zip' > android/gradle/wrapper/gradle-wrapper.properties
          
          # 6. GRADLE PROPERTIES (Silence the Mismatch)
          echo 'org.gradle.jvmargs=-Xmx4G
          android.useAndroidX=true
          android.enableJetifier=true
          kotlin.jvm.target.validation.mode=ignore' > android/gradle.properties

      # ---------------------------------------------------
      # ‚ò¢Ô∏è THE NUCLEAR RESET
      # ---------------------------------------------------
      - name: üßπ Purging Cache and Building
        run: |
          rm -f pubspec.lock
          flutter clean
          flutter pub get
          flutter build apk --release --no-tree-shake-icons

      - uses: actions/upload-artifact@v4
        with:
          name: oxcy-release-apk
          path: build/app/outputs/flutter-apk/app-release.apk
