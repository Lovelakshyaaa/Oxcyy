name: Build APK
on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
          cache: 'gradle'

      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      # ---------------------------------------------------
      # FORCE CACHE BUST â€“ include run ID in cache key
      # ---------------------------------------------------
      - name: ðŸ”„ Cache Gradle & Pub with unique key
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.pub-cache
          key: ${{ runner.os }}-build-${{ hashFiles('**/pubspec.yaml', '**/*.gradle*') }}-${{ github.run_id }}
          restore-keys: |
            ${{ runner.os }}-build-${{ hashFiles('**/pubspec.yaml', '**/*.gradle*') }}-

      # ---------------------------------------------------
      # ðŸ›¡ï¸ RECONSTRUCT ANDROID PROJECT WITH FULL PROGUARD
      # ---------------------------------------------------
      - name: ðŸ—ï¸ Reconstructing Android Project
        run: |
          flutter config --no-analytics
          flutter create --platforms=android .

          # 1. Clean old files
          rm -f android/settings.gradle android/build.gradle android/app/build.gradle
          rm -f android/gradle/wrapper/gradle-wrapper.properties

          # 2. Write FULL ProGuard rules (from your existing file)
          cat > android/app/proguard-rules.pro << 'EOF'
          # =========================================================
          # FLUTTER WRAPPERS
          # =========================================================
          -keep class io.flutter.app.** { *; }
          -keep class io.flutter.plugin.** { *; }
          -keep class io.flutter.util.** { *; }
          -keep class io.flutter.view.** { *; }
          -keep class io.flutter.** { *; }
          -keep class io.flutter.plugins.** { *; }

          # =========================================================
          # AUDIO ENGINE (JustAudio + AudioService + ExoPlayer)
          # =========================================================
          -keep class com.ryanheise.just_audio.** { *; }
          -keep class com.ryanheise.audio_session.** { *; }
          -keep class com.ryanheise.just_audio_background.** { *; }
          -keep class com.ryanheise.audioservice.** { *; }

          # âš ï¸ THE FIX: PREVENT SILENT CRASHES IN RELEASE âš ï¸
          -keep class com.google.android.exoplayer2.** { *; }
          -keep class androidx.media3.** { *; }
          -keepattributes Signature
          -keepattributes *Annotation*
          -keepattributes EnclosingMethod

          # =========================================================
          # LOCAL MUSIC & STORAGE
          # =========================================================
          -keep class com.lucasjosino.on_audio_query.** { *; }

          # =========================================================
          # ANDROID MEDIA UTILS
          # =========================================================
          -keep class android.support.v4.media.** { *; }
          -keep class androidx.media.** { *; }

          # =========================================================
          # PREVENT R8 STRIPPING GENERATED PLUGINS
          # =========================================================
          -keep class io.flutter.plugins.GeneratedPluginRegistrant { *; }

          # =========================================================
          # IGNORE HARMLESS WARNINGS
          # =========================================================
          -dontwarn com.google.android.play.core.**
          -dontwarn io.flutter.embedding.engine.deferredcomponents.**
          EOF

          # 3. SETTINGS.GRADLE
          cat > android/settings.gradle << 'EOF'
          pluginManagement {
              def flutterSdkPath = {
                  def properties = new Properties()
                  file("local.properties").withInputStream { properties.load(it) }
                  return properties.getProperty("flutter.sdk")
              }()
              includeBuild("$flutterSdkPath/packages/flutter_tools/gradle")
              repositories { google(); mavenCentral(); gradlePluginPortal() }
          }
          plugins {
              id "dev.flutter.flutter-plugin-loader" version "1.0.0"
              id "com.android.application" version "8.3.2" apply false
              id "org.jetbrains.kotlin.android" version "1.9.23" apply false
          }
          include ":app"
          EOF

          # 4. ROOT BUILD.GRADLE
          cat > android/build.gradle << 'EOF'
          allprojects {
              repositories { google(); mavenCentral() }
          }
          rootProject.buildDir = "../build"
          subprojects {
              project.buildDir = "${rootProject.buildDir}/${project.name}"
              
              // Inject namespace if missing (fix for on_audio_query)
              afterEvaluate { project ->
                  if (project.hasProperty("android")) {
                      project.android {
                          if (namespace == null) {
                              namespace = project.group.toString()
                          }
                          compileOptions {
                              sourceCompatibility = JavaVersion.VERSION_17
                              targetCompatibility = JavaVersion.VERSION_17
                          }
                      }
                      tasks.withType(org.jetbrains.kotlin.gradle.tasks.KotlinCompile).configureEach {
                          kotlinOptions { jvmTarget = "17" }
                      }
                  }
              }
          }
          tasks.register("clean", Delete) { delete rootProject.buildDir }
          EOF

          # 5. APP/BUILD.GRADLE
          cat > android/app/build.gradle << 'EOF'
          plugins {
              id "com.android.application"
              id "org.jetbrains.kotlin.android"
              id "dev.flutter.flutter-gradle-plugin"
          }
          android {
              namespace "com.example.oxcy"
              compileSdkVersion 35
              ndkVersion flutter.ndkVersion
              compileOptions {
                  sourceCompatibility JavaVersion.VERSION_17
                  targetCompatibility JavaVersion.VERSION_17
              }
              kotlinOptions { jvmTarget = "17" }
              defaultConfig {
                  applicationId "com.example.oxcy"
                  minSdkVersion 24
                  targetSdkVersion 35
              }
              buildTypes {
                  release {
                      signingConfig signingConfigs.debug
                      minifyEnabled true
                      proguardFiles(getDefaultProguardFile("proguard-android.txt"), "proguard-rules.pro")
                  }
              }
          }
          dependencies {
              implementation "org.jetbrains.kotlin:kotlin-stdlib:1.9.23"
          }
          EOF

          # 6. GRADLE WRAPPER & PROPERTIES
          mkdir -p android/gradle/wrapper
          echo 'distributionUrl=https\://services.gradle.org/distributions/gradle-8.7-all.zip' > android/gradle/wrapper/gradle-wrapper.properties
          cat > android/gradle.properties << 'EOF'
          org.gradle.jvmargs=-Xmx4G
          android.useAndroidX=true
          android.enableJetifier=true
          kotlin.jvm.target.validation.mode=ignore
          EOF

      - name: â˜¢ï¸ FINAL CLEAN & BUILD
        run: |
          rm -f pubspec.lock
          flutter clean
          flutter pub get
          flutter build apk --release --no-tree-shake-icons

      - uses: actions/upload-artifact@v4
        with:
          name: oxcy-release-apk
          path: build/app/outputs/flutter-apk/app-release.apk
